<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Location Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Live Location Tracker</h2>
  <p>Select mode:</p>
  <button class="track" onclick="startTracking()">Track My Location</button>
  <button class="view" onclick="startViewing()">View Location</button>

  <div id="tracking-section" class="hidden">
    <p class="status" id="track-status">Waiting to start...</p>
  </div>

  <div id="viewing-section" class="hidden">
    <p class="status" id="view-status">Waiting for location...</p>
    <iframe id="map" src="https://www.google.com/maps?q=&z=5&output=embed"></iframe>
  </div>

  <script>
    const SERVER_URL = "http:// 192.168.137.52:5000";

    // ------- TRACKING MODE -------
    function sendLocation(position) {
      const lat = position.coords.latitude.toFixed(6);
      const lon = position.coords.longitude.toFixed(6);

      document.getElementById("track-status").innerText = `ðŸ“¡ Sending: ${lat}, ${lon}`;

      fetch(`${SERVER_URL}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lon })
      })
      .then(res => res.json())
      .then(() => console.log("Location sent"))
      .catch(err => console.error(" Error sending:", err));
    }

    function startTracking() {
      document.getElementById("tracking-section").classList.remove("hidden");
      document.getElementById("viewing-section").classList.add("hidden");

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(sendLocation, (err) => {
          document.getElementById("track-status").innerText =
            " Could not get location. Enable GPS and allow location access.";
          console.error(err);
        }, { enableHighAccuracy: true });
      } else {
        alert("Geolocation not supported on this device.");
      }
    }

    // ------- VIEWING MODE -------
    async function fetchLocation() {
      try {
        const response = await fetch(`${SERVER_URL}/get`);
        const data = await response.json();

        if (data.lat && data.lon) {
          document.getElementById("view-status").innerText = `Lat: ${data.lat}, Lon: ${data.lon}`;
          document.getElementById("map").src =
            `https://www.google.com/maps?q=${data.lat},${data.lon}&z=15&output=embed`;
        } else {
          document.getElementById("view-status").innerText = " Waiting for tracked phone to send location...";
        }
      } catch (err) {
        console.error("Error fetching location:", err);
      }
    }

    function startViewing() {
      document.getElementById("viewing-section").classList.remove("hidden");
      document.getElementById("tracking-section").classList.add("hidden");
      setInterval(fetchLocation, 3000);
    }
  </script>
</body>
</html>
